#!/bin/bash
set -eux

. "$(dirname "$(readlink -f "$0")")"/functions.sh

VERSION_FILE="build_version"

# Describe version-depend variables:
PUPPET_MURANO_REF=${MURANO_REF:-'stable/mitaka'}
PUPPET_MURANO_GIT=${MURANO_REF:-'https://github.com/openstack/puppet-murano.git'}
# Add murano packages and some dependencies, from master pkg's repo:
MURANO_PACKAGES_URLS_DEFAULT="http://mirror.fuel-infra.org/extras/murano-plugin-repos/ubuntu/9.0/pool/main/"

MURANO_PACKAGES_URLS=${MURANO_PACKAGES_URLS:-${MURANO_PACKAGES_URLS_DEFAULT}}

for url in ${MURANO_PACKAGES_URLS}; do
  download_package 'deb' "${url}"
done

download_puppet_module "murano" ${PUPPET_MURANO_GIT} ${PUPPET_MURANO_REF}

# generate deb version file
generate_deb_version_file "${VERSION_FILE}"

# add info about MURANO_TARBALL
echo "PUPPET_MURANO_REF=${PUPPET_MURANO_REF}" >> "${VERSION_FILE}"
echo "PUPPET_MURANO_GIT=${PUPPET_MURANO_GIT}" >> "${VERSION_FILE}"
echo "PUPPET_MURANO_COMMIT=$(git ls-remote -h ${PUPPET_MURANO_GIT} |grep "refs/heads/${PUPPET_MURANO_REF}" |awk '{print $1}' )" >> "${VERSION_FILE}"
